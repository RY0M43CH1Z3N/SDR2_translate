################################################################################
### Copyright © 2012-2013 BlackDragonHunt
### Copyright © 2012-2013 /a/nonymous scanlations
### 
### This file is part of the Super Duper Script Editor.
### 
### The Super Duper Script Editor is free software: you can redistribute it
### and/or modify it under the terms of the GNU General Public License as
### published by the Free Software Foundation, either version 3 of the License,
### or (at your option) any later version.
### 
### The Super Duper Script Editor is distributed in the hope that it will be
### useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
### GNU General Public License for more details.
### 
### You should have received a copy of the GNU General Public License
### along with the Super Duper Script Editor.
### If not, see <http://www.gnu.org/licenses/>.
################################################################################

#from bitstring import array.array, BitStream
from enum import Enum
import array, os
import Common
import clt

NAME    = "name"
ENABLED = "enabled"
CFG_ID  = "cfg_id"
DATA    = "data"
POS     = "pos"
ORIG    = "orig"
PATCH   = "patch"

# LANGUAGES   = [u"Japanese", u"English", u"French", u"Spanish", u"German", u"Italian", u"Dutch", u"Portuguese", u"Russian", u"Korean", u"Traditional Chinese", u"Simplified Chinese"]
LANGUAGES   = [u"日本語", u"English", u"Français", u"Español", u"Deutsch", u"Italiano", u"Nederlands", u"Português", u"Русский", u"한국어", u"繁體中文", u"简体中文"]
LANG_CFG_ID = "sys_menu_lang"
CLT_CFG_ID  = "custom_clt"

EBOOT_PATCHES = [
  {NAME: "Extend EBOOT", ENABLED: True, CFG_ID: None, DATA:
    [
      {POS: 0x0000002C, ORIG: array.array('B', [0x03, 0x00]), PATCH: array.array('B', [0x04, 0x00])},
      {POS: 0x00000054, ORIG: array.array('B', [0x01,0x00,0x00,0x00,0x40,0xCB,0x20,0x00,0x80,0xCA,0x20,0x00,0x00,0x00,0x00,0x00,0x28,0xE4,0x00,0x00,0x84,0x2A,0x2E,0x00,0x06,0x00,0x00,0x00,0x40,0x00,0x00,0x00]), PATCH: array.array('B', [0x01,0x00,0x00,0x00,0x40,0xCB,0x20,0x00,0x20,0xF5,0x4E,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x01,0x00,0x00,0x20,0x01,0x00,0x07,0x00,0x00,0x00,0x10,0x00,0x00,0x00])},
      {POS: 0x00000074, ORIG: array.array('B', [0xA0,0x00,0x00,0x70,0x70,0xAF,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xD8,0x56,0x0D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0x01,0x00,0x00,0x00,0x40,0xEB,0x21,0x00,0x80,0xCA,0x20,0x00,0x00,0x00,0x00,0x00,0x28,0xE4,0x00,0x00,0x84,0x2A,0x2E,0x00,0x06,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0xA0,0x00,0x00,0x70,0x70,0xCF,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xD8,0x56,0x0D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00])},
    ]
  },
  {NAME: "Game Button Order", ENABLED: False, CFG_ID: "01_game_btn", DATA:
    [
      {POS: 0x0007A4C8, ORIG: array.array('B', [0x04,0x00,0xB1,0x8F]), PATCH: array.array('B', [0x48,0xCD,0x33,0x0A])},
      {POS: 0x0020CB40, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0x04,0x00,0xB1,0x8F,0x21,0x20,0x20,0x02,0x00,0x20,0x25,0x32,0x02,0x00,0xA0,0x14,0x00,0x40,0x31,0x36,0x00,0x40,0x31,0x3A,0x00,0x40,0x84,0x30,0x02,0x00,0x80,0x14,0x00,0x20,0x31,0x36,0x00,0x20,0x31,0x3A,0x03,0xF9,0x21,0x0A,0x00,0x00,0x00,0x00])},
    ]
  },
  {NAME: "Home/Save Button Order", ENABLED: False, CFG_ID: "03_home_btn", DATA:
    [
      {POS: 0x0008CCF8, ORIG: array.array('B', [0x21,0x10,0x80,0x00]), PATCH: array.array('B', [0x01,0x00,0x02,0x24])},
    ]
  },
  {NAME: "Fix Error Code 80020148", ENABLED: True, CFG_ID: "04_fix_80020148", DATA:
    [
      {POS: 0x00000004, ORIG: array.array('B', [0x00]), PATCH: array.array('B', [0x01])},
      {POS: 0x00000007, ORIG: array.array('B', [0x01]), PATCH: array.array('B', [0x00])},
    ]
  },
  {NAME: "Increase Dialog Line Limit to 96 Characters", ENABLED: True, CFG_ID: "05_dialog_line_96", DATA:
    [
      # Move current line buffer: raw addresses (0x08CAF3C6 -> 0x08CF3550)
      {POS: 0x000CB528, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000CB534, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000D1BD0, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000D1BD4, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000D25D8, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000D25DC, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000D962C, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000D9638, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000D963C, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000DB820, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000DB824, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000DB828, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000DB82C, ORIG: array.array('B', [0x26,0xEA]), PATCH: array.array('B', [0xD0,0x2D])},
      {POS: 0x000DB95C, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000DB960, ORIG: array.array('B', [0x26,0xEA]), PATCH: array.array('B', [0xD0,0x2D])},
      {POS: 0x000DB96C, ORIG: array.array('B', [0x38,0x00]), PATCH: array.array('B', [0xC0,0x00])},
      {POS: 0x000DCFE0, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000DCFEC, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000DE5E8, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000DE5F4, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000DE92C, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000DE938, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000DE93C, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000FF1DC, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000FF230, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000FF1E4, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000FF2D0, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000FF2D8, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000FFD34, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000FFD38, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x000FFE44, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x000FFE48, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x001000B0, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x00100430, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x00100598, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x0010059C, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      {POS: 0x00100724, ORIG: array.array('B', [0x2A,0x00]), PATCH: array.array('B', [0x2E,0x00])},
      {POS: 0x0010072C, ORIG: array.array('B', [0x46,0xE9]), PATCH: array.array('B', [0xD0,0x2A])},
      # Move current line buffer: relative addresses
      {POS: 0x0020CFF0, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x04,0x3C,0xEA,0x32,0x84,0x24,0x08,0x00,0xE0,0x03,0x21,0x10,0x44,0x00])},
      {POS: 0x000CE600, ORIG: array.array('B', [0x40,0x10,0x05,0x00,0x21,0x10,0x48,0x00]), PATCH: array.array('B', [0x74,0xCE,0x33,0x0E,0x40,0x10,0x05,0x00])},
      {POS: 0x0020D000, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x07,0x3C,0xEA,0x32,0xE7,0x24,0x08,0x00,0xE0,0x03,0x21,0x10,0x47,0x00])},
      {POS: 0x000CE754, ORIG: array.array('B', [0x40,0x10,0x06,0x00,0x21,0x10,0x48,0x00]), PATCH: array.array('B', [0x78,0xCE,0x33,0x0E,0x40,0x10,0x06,0x00])},
      {POS: 0x0020D010, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x04,0x3C,0xEA,0x32,0x84,0x24,0x08,0x00,0xE0,0x03,0x21,0x18,0x64,0x00])},
      {POS: 0x000CE7EC, ORIG: array.array('B', [0x40,0x18,0x0A,0x00,0x21,0x18,0x7E,0x00]), PATCH: array.array('B', [0x7C,0xCE,0x33,0x0E,0x40,0x18,0x0A,0x00])},
      {POS: 0x0020D020, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x03,0x3C,0xEA,0x32,0x63,0x24,0x08,0x00,0xE0,0x03,0x21,0x10,0x43,0x00])},
      {POS: 0x000CE9C4, ORIG: array.array('B', [0x40,0x10,0x04,0x00,0x21,0x10,0x50,0x00]), PATCH: array.array('B', [0x80,0xCE,0x33,0x0E,0x40,0x10,0x04,0x00])},
      {POS: 0x0020D030, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x07,0x3C,0xEA,0x32,0xE7,0x24,0x08,0x00,0xE0,0x03,0x21,0x10,0x47,0x00])},
      {POS: 0x000CEA84, ORIG: array.array('B', [0x40,0x10,0x06,0x00,0x21,0x10,0x50,0x00]), PATCH: array.array('B', [0x84,0xCE,0x33,0x0E,0x40,0x10,0x06,0x00])},
      {POS: 0x0020D040, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x04,0x3C,0xEA,0x32,0x84,0x24,0x08,0x00,0xE0,0x03,0x21,0x18,0x64,0x00])},
      {POS: 0x000CEB10, ORIG: array.array('B', [0x40,0x18,0x0A,0x00,0x21,0x18,0x71,0x00]), PATCH: array.array('B', [0x88,0xCE,0x33,0x0E,0x40,0x18,0x0A,0x00])},
      {POS: 0x000CE974, ORIG: array.array('B', [0x66,0x02,0xA2,0x94,0x00,0x01,0x42,0x2C]), PATCH: array.array('B', [0x8C,0xCE,0x33,0x0E,0x00,0x00,0x00,0x00])},
      {POS: 0x0020D050, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x02,0x3C,0x50,0x35,0x42,0x94,0x08,0x00,0xE0,0x03,0x00,0x01,0x42,0x2C])},
      # Move current line CLT buffer: relative addreses
      {POS: 0x0020D060, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x07,0x3C,0x0A,0x35,0xE7,0x24,0x08,0x00,0xE0,0x03,0x21,0x50,0x47,0x01])},
      {POS: 0x000CE7F4, ORIG: array.array('B', [0x23,0x10,0x47,0x00,0x21,0x50,0x5E,0x01]), PATCH: array.array('B', [0x90,0xCE,0x33,0x0E,0x23,0x10,0x47,0x00])},
      {POS: 0x0020D070, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x07,0x3C,0x0A,0x35,0xE7,0x24,0x08,0x00,0xE0,0x03,0x21,0x50,0x47,0x01])},
      {POS: 0x000CEB18, ORIG: array.array('B', [0x23,0x10,0x47,0x00,0x21,0x50,0x51,0x01]), PATCH: array.array('B', [0x94,0xCE,0x33,0x0E,0x23,0x10,0x47,0x00])},
      # Move current line CLT buffer: load
      {POS: 0x0020D080, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x08,0x3C,0x50,0x38,0x08,0x25,0x21,0x40,0x06,0x01,0x08,0x00,0xE0,0x03,0x00,0x00,0x08,0x91])},
      {POS: 0x000CEB88, ORIG: array.array('B', [0x19,0x00,0x97,0x00,0x21,0x10,0x70,0x00,0xBA,0x03,0x05,0x86,0xBC,0x03,0x06,0x86,0x46,0x03,0x48,0x90]), PATCH: array.array('B', [0x98,0xCE,0x33,0x0E,0x19,0x00,0x97,0x00,0x21,0x10,0x70,0x00,0xBA,0x03,0x05,0x86,0xBC,0x03,0x06,0x86])},
      {POS: 0x000CEBC0, ORIG: array.array('B', [0x19,0x00,0x92,0x00,0x21,0x10,0x70,0x00,0xBA,0x03,0x05,0x86,0xBC,0x03,0x06,0x86,0x46,0x03,0x48,0x90]), PATCH: array.array('B', [0x98,0xCE,0x33,0x0E,0x19,0x00,0x92,0x00,0x21,0x10,0x70,0x00,0xBA,0x03,0x05,0x86,0xBC,0x03,0x06,0x86])},
      {POS: 0x000CEC04, ORIG: array.array('B', [0x21,0x10,0xC8,0x00,0xBA,0x03,0x05,0x85,0xBC,0x03,0x06,0x85,0x46,0x03,0x48,0x90]), PATCH: array.array('B', [0x98,0xCE,0x33,0x0E,0x21,0x10,0xC8,0x00,0xBA,0x03,0x05,0x85,0xBC,0x03,0x06,0x85])},
      {POS: 0x000CEC30, ORIG: array.array('B', [0xBA,0x03,0x05,0x86,0xBC,0x03,0x06,0x86,0x46,0x03,0x48,0x90]), PATCH: array.array('B', [0x98,0xCE,0x33,0x0E,0xBA,0x03,0x05,0x86,0xBC,0x03,0x06,0x86])},
      # Move current line buffer and current line CLT buffer: 0xDB91C
      {POS: 0x000DB9DC, ORIG: array.array('B', [0x40,0x10,0x0B,0x00,0x21,0x10,0x45,0x00]), PATCH: array.array('B', [0xA0,0xCE,0x33,0x0E,0x40,0x10,0x0B,0x00])},
      {POS: 0x000DB9E4, ORIG: array.array('B', [0x21,0x18,0x65,0x01]), PATCH: array.array('B', [0x00,0x00,0x00,0x00])},
      {POS: 0x0020D0A0, ORIG: array.array('B', [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]), PATCH: array.array('B', [0xCF,0x08,0x0A,0x3C,0xEA,0x32,0x4A,0x25,0x21,0x10,0x4A,0x00,0xCF,0x08,0x0A,0x3C,0x0A,0x35,0x4A,0x25,0x08,0x00,0xE0,0x03,0x21,0x18,0x6A,0x01])},
      # Reducing backlog length from 512 lines to 144 lines
      {POS: 0x000CECA4, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000CECB0, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000CECB8, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000CEEB0, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000CEEF8, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000DBAA8, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000DBAD0, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000DBAD4, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x000DBAF8, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x0016814C, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      {POS: 0x0016819C, ORIG: array.array('B', [0x00, 0x02]), PATCH: array.array('B', [0x09, 0x00])},
      # Change line length: 28 -> 96
      {POS: 0x000CED00, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000CEDFC, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000D7CA0, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000D8B7C, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000D90C4, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000DB830, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000DB9B0, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000DBA5C, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      {POS: 0x000DBAC0, ORIG: array.array('B', [0x1C, 0x00]), PATCH: array.array('B', [0x60, 0x00])},
      # Change line length: 84 -> 288
      {POS: 0x000CE8D8, ORIG: array.array('B', [0x54,0x00]), PATCH: array.array('B', [0x20,0x01])},
      # Change line length: 112 -> 384
      {POS: 0x000CE5E0, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CE618, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CE6BC, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CE8CC, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CE8F0, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CE9DC, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CE9F8, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000CEB68, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      {POS: 0x000D2410, ORIG: array.array('B', [0x70, 0x00]), PATCH: array.array('B', [0x80, 0x01])},
      # Change line length: 224 -> 768
      {POS: 0x000CB53C, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000CFEB8, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000D1BDC, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000D25E8, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000D7C94, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000D8B70, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000D9644, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000DCFF4, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000DE5FC, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000DE944, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000FF1F0, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000FF2DC, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000FFD44, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x000FFE50, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x0010043C, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x001005AC, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      {POS: 0x00100734, ORIG: array.array('B', [0xE0, 0x00]), PATCH: array.array('B', [0x00, 0x03])},
      # Change line length: sll ... 2 -> sll ... 5
      {POS: 0x000CE720, ORIG: array.array('B', [0x80,0x10,0x09,0x00]), PATCH: array.array('B', [0x40,0x11,0x09,0x00])},
      {POS: 0x000CE934, ORIG: array.array('B', [0x80,0x20,0x03,0x00]), PATCH: array.array('B', [0x40,0x21,0x03,0x00])},
      {POS: 0x000CEA1C, ORIG: array.array('B', [0x80,0x10,0x05,0x00]), PATCH: array.array('B', [0x40,0x11,0x05,0x00])},
      {POS: 0x000CEA54, ORIG: array.array('B', [0x80,0x10,0x09,0x00]), PATCH: array.array('B', [0x40,0x11,0x09,0x00])},
      {POS: 0x000CED08, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000CED40, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000CEDB4, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000CEE04, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000CEE40, ORIG: array.array('B', [0x80,0x18,0x09,0x00]), PATCH: array.array('B', [0x40,0x19,0x09,0x00])},
      {POS: 0x000DB9B8, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000DBA08, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000DBA3C, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      {POS: 0x000DBD48, ORIG: array.array('B', [0x80,0x18,0x03,0x00]), PATCH: array.array('B', [0x40,0x19,0x03,0x00])},
      # Change line length: sll ... 5 -> sll ... 7
      {POS: 0x000CE724, ORIG: array.array('B', [0x40,0x19,0x09,0x00]), PATCH: array.array('B', [0xC0,0x19,0x09,0x00])},
      {POS: 0x000CE938, ORIG: array.array('B', [0x40,0x11,0x03,0x00]), PATCH: array.array('B', [0xC0,0x11,0x03,0x00])},
      {POS: 0x000CEA20, ORIG: array.array('B', [0x40,0x19,0x05,0x00]), PATCH: array.array('B', [0xC0,0x19,0x05,0x00])},
      {POS: 0x000CEA58, ORIG: array.array('B', [0x40,0x19,0x09,0x00]), PATCH: array.array('B', [0xC0,0x19,0x09,0x00])},
      {POS: 0x000CED04, ORIG: array.array('B', [0x40,0x11,0x03,0x00]), PATCH: array.array('B', [0xC0,0x11,0x03,0x00])},
      {POS: 0x000CED3C, ORIG: array.array('B', [0x40,0x21,0x03,0x00]), PATCH: array.array('B', [0xC0,0x21,0x03,0x00])},
      {POS: 0x000CEDB0, ORIG: array.array('B', [0x40,0x21,0x03,0x00]), PATCH: array.array('B', [0xC0,0x21,0x03,0x00])},
      {POS: 0x000CEE00, ORIG: array.array('B', [0x40,0x11,0x03,0x00]), PATCH: array.array('B', [0xC0,0x11,0x03,0x00])},
      {POS: 0x000CEE44, ORIG: array.array('B', [0x40,0x11,0x09,0x00]), PATCH: array.array('B', [0xC0,0x11,0x09,0x00])},
      {POS: 0x000DB9B4, ORIG: array.array('B', [0x40,0x11,0x03,0x00]), PATCH: array.array('B', [0xC0,0x11,0x03,0x00])},
      {POS: 0x000DBA04, ORIG: array.array('B', [0x40,0x21,0x03,0x00]), PATCH: array.array('B', [0xC0,0x21,0x03,0x00])},
      {POS: 0x000DBA38, ORIG: array.array('B', [0x40,0x11,0x03,0x00]), PATCH: array.array('B', [0xC0,0x11,0x03,0x00])},
      {POS: 0x000DBD44, ORIG: array.array('B', [0x40,0x11,0x03,0x00]), PATCH: array.array('B', [0xC0,0x11,0x03,0x00])},
      # Change line length: divisor 0x24924925 -> 0x0AAAAAAB
      {POS: 0x001FA5CC, ORIG: array.array('B', [0x25,0x49,0x92,0x24]), PATCH: array.array('B', [0xAB,0xAA,0xAA,0x0A])},
      {POS: 0x000CE998, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x000D8378, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x000E69E4, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x000FBAB8, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x001673F0, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x00167748, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x001677D0, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x00167910, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x00174610, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x0017F720, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x0017FDA8, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x001800EC, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x00180460, ORIG: array.array('B', [0x92,0x24]), PATCH: array.array('B', [0xAA,0x0A])},
      {POS: 0x000CE99C, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x000D837C, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x000E69E8, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x000FBABC, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x001673F4, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x0016774C, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x001677D8, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x00167918, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x00174618, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x0017F728, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x0017FDB0, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x001800F8, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
      {POS: 0x0018046C, ORIG: array.array('B', [0x25,0x49]), PATCH: array.array('B', [0xAB,0xAA])},
    ]
  },
  {NAME: "Fix Line Height", ENABLED: True, CFG_ID: "06_line_height_fix", DATA:
    [
      {POS: 0x001F9BB0, ORIG: array.array('B', [0x00,0x00,0x08,0x43]), PATCH: array.array('B', [0x00,0x00,0x10,0x43])},
      # It fixes the offset. Offset is calculated in the cycle between 0887A740 and 0887A768 in memory.
      # Offset by Y is in f3, which is calculated as f3 = f0 - f24.
      # f24 value is gathered at 0887A160, which 0x001F9BB0 in EBOOT. its value is  0x43080000
      # It corresponds to 136 in FPU. If changed to 0x43100000, which is 144, it does the trick
    ]
  },
  {NAME: "Custom CLT", ENABLED: False, CFG_ID: CLT_CFG_ID, DATA: []},
]

def apply_sys_lang(eboot):
  
  #if LANG_CFG_ID in common.editor_config.hacks:
  #  sys_menu_lang = common.editor_config.hacks[LANG_CFG_ID]
  #else:
  #  sys_menu_lang = 1
  #  common.editor_config.hacks[LANG_CFG_ID] = sys_menu_lang

  sys_menu_lang = 1
  
  patch_loc = 0x0008C2FC
  patch = array.array('B', [sys_menu_lang]) + array.array('B', [0x00,0x02,0x24])
  l = len(patch)
  eboot[patch_loc:patch_loc+l] = patch
  
  return eboot

def apply_clt_patch(eboot):
  
  #if common.editor_config.hacks[CLT_CFG_ID]:
  #  styles = clt.CLT_STYLES
  #else:
  #  styles = clt.CLT_ORIGINAL

  styles = clt.CLT_ORIGINAL
  patch_loc = 0x207288
  for i in sorted(styles.keys()):
    if i > clt.MAX_CLT:
      break
    
    patch = styles[i].to_bin()
    l = len(patch)
    loc = patch_loc + (i * 0x10)
    eboot[loc:loc+l] = patch
  
  return eboot

def extend_eboot(eboot):
  
  NEW_SECTION_POS     = 0x20CB40
  NEW_SECTION_SIZE    = 73728
  
  ORIG_SIZE           = 3081800
  EXTENDED_SIZE       = ORIG_SIZE + NEW_SECTION_SIZE
  
  # Already extended, don't need to do it again.
  if len(eboot) == EXTENDED_SIZE:
    return eboot
  elif len(eboot) != ORIG_SIZE:
    raise ValueError("EBOOT neither matches original nor extended size. Try restoring the original, decrypted EBOOT.BIN to PSP_GAME/SYSDIR, then repack everything.")

  eboot[NEW_SECTION_POS:NEW_SECTION_POS] = array.array('B', [0] * NEW_SECTION_SIZE)
  
  # Since we're adding another program segment between program segments 0 and 1,
  # we need to update references to program segment 1 on the relocation table
  # so that they point to program segment 2.
  #
  # The pseudocode for this step is:
  # 
  # For b = every 8 bytes from 0x22CF70 to the end of the file:
  #   If b[5] == 1, replace it with 2.
  #   If b[6] == 1, replace it with 2.
  TABLE_START = 0x22CF70
  pos = TABLE_START # +1 because array has the 
  
  while pos < len(eboot)-1:
    # Go to b[5]
    pos += 5
    if eboot[pos] == 0x01:
      eboot[pos] = 0x02
    # Next to b[6]
    pos += 1
    if eboot[pos] == 0x01:
      eboot[pos] = 0x02
    # And to the new line
    pos += 2
  return eboot

def apply_eboot_patches(eboot):
  
  eboot = extend_eboot(eboot)
  
  for patch in EBOOT_PATCHES:
  
    enabled = patch[ENABLED]
    #if patch[CFG_ID] and patch[CFG_ID] in common.editor_config.hacks:
    #  enabled = common.editor_config.hacks[patch[CFG_ID]]
    
    # So we can undo patches if they've already been applied.
    key = PATCH if enabled else ORIG
    
    for item in patch[DATA]:
      l = len(item[key])
      eboot[item[POS]:item[POS]+l] = item[key]
  
  eboot = apply_sys_lang(eboot)
  eboot = apply_clt_patch(eboot)
  
  return eboot

if __name__ == "__main__":
  src = "Test/EBOOT.BIN"
  dst = "Test/EBOOT_PATCHED.BIN"
  
  test = array.array('B')
  test.fromfile(open(src,'rb'), os.path.getsize(src)/test.itemsize)
  test = apply_eboot_patches(test)
  
  with open(dst, "wb") as f:
    test.tofile(f)

### EOF ###
